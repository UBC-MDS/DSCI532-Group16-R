library(dash)
library(dashCoreComponents)
library(dashHtmlComponents)
library(dashBootstrapComponents)
library(ggplot2)
library(tidyverse)
library(plotly)


app <- Dash$new(external_stylesheets = 'https://stackpath.bootstrapcdn.com/bootswatch/4.5.2/lux/bootstrap.min.css')


data = read_csv('data/processed/processed_survey.csv')
statedf <- read.csv("https://raw.githubusercontent.com/plotly/datasets/master/2011_us_ag_exports.csv")

dropdown_states <- unique(data[c("state_fullname", "state")]) %>%
    arrange(state_fullname)

ls_state <- list(list(label='All',value='ALL'))
for (row in 1:nrow(dropdown_states)) {
   fn <- dropdown_states[row, 'state_fullname'] %>% pull(1)
   abbrev <- dropdown_states[row, 'state'] %>% pull(1)
   ls_state <- append(ls_state, list(list(label=fn, value=abbrev)))   
}
dropdown_state_ls <- ls_state

SIDEBAR_STYLE <- list(
    'position'="fixed",
    'top'=0,
    'left'=0,
    'bottom'=0,
    'width'="18rem",
    'padding'="2rem 1rem",
    'background-color'="#f8f9fa"
)

sidebar <- htmlDiv(list(
        htmlBr(),
        htmlH3("Filters", className="display-5"),
        htmlHr(),
        htmlH4(htmlLabel('State Selection')), 
        dccDropdown(
            id = 'state_selector',
            options=dropdown_state_ls, #{'label': state_full, 'value': state_abbrev} for state_full, state_abbrev in list(zip(df_states.state_fullname, df_states.state))],
            value='ALL', 
            multi=FALSE,
            clearable=FALSE,
            style=list('height'= '30px', 'width'= '250px')
            ),        
        htmlBr(),       
        
        #Age Filter
        htmlH4(htmlLabel('Age')),
        dccRangeSlider(
          id='age-range-slider',
          min=18,
          max=75,
          step=2,
          marks=list(
            "18" = "18",
            "30" = "30",
            "40" = "40",
            "50" = "50",
            "60" = "60",
            "70" = "70",
            "75" = "75"
          ),
          value=list(18, 75)),
          htmlBr(),
        
          # Gender Filter Checklist
          htmlH4(htmlLabel('Gender')),
          dccChecklist(
              id = 'gender_checklist',
              options = list(
                  list('label'=' Male', 'value' ='Male'),
                  list('label' = ' Female',  'value' = 'Female'),
                  list('label' = ' Other', 'value' = 'Other')),
              value = list('Male', 'Female', 'Other'),
              labelStyle = list('display'='block')
          ),
          htmlBr(),
        
          # Self-Employed Filter Checklist
          htmlH4(htmlLabel('Self-Employed')),
          dccChecklist(
              id = 'self_emp_checklist',
              options = list(
                  list('label' = ' Yes', 'value' = 'Yes'),
                  list('label' = ' No', 'value' = 'No'),
                  list('label' = ' N/A', 'value' = 'N/A')),
              value = list('Yes', 'No', 'N/A'),            
              labelStyle = list('display'='block')
              
          ),          
          
         
      htmlDiv(id='output-container-range-slider')
    ), 
    style=SIDEBAR_STYLE
  )

CONTENT_STYLE <- list(
    'margin-left'="18rem",
    'margin-right'="2rem",
    'padding'="2rem 1rem"
)

content <- htmlDiv(list(
  htmlH2('Employee Mental Health Survey in the US'),
  htmlBr(),
  dccTabs(id="tabs", children=list(
    dccTab(label='Employee perception', children=list(
      htmlBr(),
      htmlBr(),
      # Map figure
      dccGraph(id='map-plot'),

      # Options Bar Plot
      dccGraph(id = 'option_bar_plot'),

      # Discuss mental issues Bar Plot
      dccGraph(id = 'discuss_w_supervisor')
        )
    ),
    dccTab(label='Employer support', children=list(      
      )
    ))
  )),
  style=CONTENT_STYLE
)

#Main Layout
app$layout(htmlDiv(
    
    list(
    #side bar div
    sidebar,
    #content div
    content
    )
 
))

app$callback(
  output('map-plot', 'figure'),
  list(input('age-range-slider', 'value'),
       input('gender_checklist', 'value'),
       input('self_emp_checklist', 'value'),
       input('state_selector', 'value')),
  function(age_chosen, gender_chosen, self_emp_chosen, state_chosen) {
    
    # Filter data
    filtered_data <- data %>% filter(Age >= age_chosen[1] & Age <= age_chosen[2] & 
                                       Gender %in% gender_chosen &
                                       self_employed %in% self_emp_chosen &
                                       (  state_chosen == 'ALL' | state %in% state_chosen))
    
    # Create frequencydf
    colnames(filtered_data)[6] <- "code"
    grouped_data <- filtered_data %>%
      group_by(code) %>%
      summarize(mental_health_condition = sum(has_condition))
    frequencydf <- left_join(statedf, grouped_data, by = 'code')

    # Plot map
    p <- plot_ly(frequencydf, type = 'choropleth', locationmode = 'USA-states',
                 z = ~mental_health_condition, locations = ~code, color = ~mental_health_condition, colors = 'PuBu') %>%
                layout(geo = list(scope = 'usa', projection = list(type = 'albers usa')), 
                title = paste(str(state_chosen),'Frequency of mental health condition'), clickmode = 'event+select')
    
    ggplotly(p)
  }
)

#Options Barplot Callback
app$callback(
  output('option_bar_plot', 'figure'),
  list(input('age-range-slider', 'value'),       
       input('gender_checklist', 'value'),
       input('self_emp_checklist', 'value'),
       input('state_selector', 'value')),
  function(age_chosen, gender_chosen, self_emp_chosen, state_chosen) {
    p <- ggplot(data %>% filter(Age >= age_chosen[1] & Age <= age_chosen[2] & 
                                  # state == state_chosen &
                                  Gender %in% gender_chosen &
                                  self_employed %in% self_emp_chosen &
                                  (    state_chosen == 'ALL' |  state %in% state_chosen)                                  
                                  )) +
      aes(y = benefits) +
      geom_bar() +
      labs(x = 'Count of Records', y = '', title = 'Do you know know the options for mental healthcare your employer provides?')
    ggplotly(p)
  }
)

#Discuss w supervisor Callback
app$callback(
  output('discuss_w_supervisor', 'figure'),
  list(input('age-range-slider', 'value'),       
       input('gender_checklist', 'value'),
       input('self_emp_checklist', 'value'),
       input('state_selector', 'value')),
  function(age_chosen, gender_chosen, self_emp_chosen, state_chosen) {
    p <- ggplot(data %>% filter(Age >= age_chosen[1] & Age <= age_chosen[2] &
                             # state == state_chosen &
                             Gender %in% gender_chosen &
                             self_employed %in% self_emp_chosen  &
                                  (    state_chosen == 'ALL' |  state %in% state_chosen) )) +
      aes(x = supervisor, y = Age) +
      geom_boxplot() +
      coord_flip() +
      # coord_cartesian(xlim=c(18,80)) +
      labs(x = "Supervisor", title = "Would employee be willing to discuss mental health issues with supervisor?")
    ggplotly(p)
  }
)

app$run_server(debug = T, host='0.0.0.0')
